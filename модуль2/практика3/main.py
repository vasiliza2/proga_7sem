"""
–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–±–æ—Ç–∞ 3: –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
–ü—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è
"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from datetime import datetime

# ============================================
# 1. –°–û–ó–î–ê–ù–ò–ï –¢–ï–°–¢–û–í–´–• –î–ê–ù–ù–´–•
# ============================================

print("üìä –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...")

# –î–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (25 —É—á–µ–Ω–∏–∫–æ–≤, 10 –∑–∞–¥–∞–Ω–∏–π)
students = ['–ò–≤–∞–Ω–æ–≤ –ò.–ò.', '–ü–µ—Ç—Ä–æ–≤–∞ –ú.–ê.', '–°–∏–¥–æ—Ä–æ–≤ –ü.–°.', '–ö–æ–∑–ª–æ–≤–∞ –ê.–í.', '–°–º–∏—Ä–Ω–æ–≤ –î.–ò.',
            '–ù–æ–≤–∏–∫–æ–≤–∞ –ï.–ü.', '–§—ë–¥–æ—Ä–æ–≤ –ê.–ù.', '–ú–æ—Ä–æ–∑–æ–≤–∞ –ö.–°.', '–°–æ–∫–æ–ª–æ–≤ –í.–ü.', '–õ–µ–±–µ–¥–µ–≤–∞ –û.–ú.',
            '–í–æ–ª–∫–æ–≤ –ê.–ê.', '–ó–∞–π—Ü–µ–≤–∞ –¢.–ù.', '–ú–µ–¥–≤–µ–¥–µ–≤ –°.–°.', '–õ–∏—Å–∏—Ü—ã–Ω–∞ –û.–í.', '–°–æ–ª–æ–≤—å—ë–≤ –ü.–ü.',
            '–û—Ä–ª–æ–≤–∞ –ú.–ú.', '–ü–∞–≤–ª–æ–≤ –ò.–ò.', '–°–µ–º—ë–Ω–æ–≤–∞ –ê.–ê.', '–ì–æ–ª—É–±–µ–≤ –î.–î.', '–í–æ—Ä–æ–±—å—ë–≤–∞ –õ.–õ.',
            '–õ–µ–±–µ–¥–µ–≤ –ú.–ú.', '–ï–≥–æ—Ä–æ–≤–∞ –°.–°.', '–ö–æ–º–∞—Ä–æ–≤ –í.–í.', '–ò–ª—å–∏–Ω–∞ –ù.–ù.', '–ñ—É–∫–æ–≤ –ê.–ê.']

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (0 - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, 1 - –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
np.random.seed(42)  # –î–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏

data = {'–£—á–µ–Ω–∏–∫': students}
for i in range(1, 11):
    # –°–æ–∑–¥–∞–µ–º —Ä–∞–∑–Ω—É—é —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∑–∞–¥–∞–Ω–∏–π
    if i <= 3:  # –õ–µ–≥–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è
        prob = 0.8  # 80% –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö
    elif i <= 7:  # –°—Ä–µ–¥–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è
        prob = 0.6  # 60% –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö
    else:  # –°–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è
        prob = 0.4  # 40% –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö

    data[f'–ó–∞–¥–∞–Ω–∏–µ_{i}'] = np.random.choice([0, 1], size=len(students), p=[1 - prob, prob])

results_df = pd.DataFrame(data)

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞–Ω–∏—è—Ö
test_info = pd.DataFrame({
    '–ó–∞–¥–∞–Ω–∏–µ': [f'–ó–∞–¥–∞–Ω–∏–µ_{i}' for i in range(1, 11)],
    '–¢–µ–º–∞': ['–ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è', '–ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è', '–¢–µ–æ—Ä–µ–º–∞ –ü–∏—Ñ–∞–≥–æ—Ä–∞',
             '–¢–µ–æ—Ä–µ–º–∞ –ü–∏—Ñ–∞–≥–æ—Ä–∞', '–¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è', '–¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è', '–õ–æ–≥–∞—Ä–∏—Ñ–º—ã',
             '–õ–æ–≥–∞—Ä–∏—Ñ–º—ã', '–ü—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è', '–ü—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è'],
    '–ú–∞–∫—Å_–±–∞–ª–ª': [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    '–°–ª–æ–∂–Ω–æ—Å—Ç—å': ['–õ–µ–≥–∫–æ', '–°—Ä–µ–¥–Ω–µ', '–õ–µ–≥–∫–æ', '–°—Ä–µ–¥–Ω–µ', '–°—Ä–µ–¥–Ω–µ',
                  '–°–ª–æ–∂–Ω–æ', '–°—Ä–µ–¥–Ω–µ', '–°–ª–æ–∂–Ω–æ', '–°–ª–æ–∂–Ω–æ', '–°–ª–æ–∂–Ω–æ']
})

print(f"‚úÖ –°–æ–∑–¥–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ: {len(students)} —É—á–µ–Ω–∏–∫–æ–≤, 10 –∑–∞–¥–∞–Ω–∏–π")

# ============================================
# 2. –ê–ù–ê–õ–ò–ó –†–ï–ó–£–õ–¨–¢–ê–¢–û–í
# ============================================

print("\nüîç –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...")

# –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π
questions = [f'–ó–∞–¥–∞–Ω–∏–µ_{i}' for i in range(1, 11)]

# 2.1. –ë–∞–ª–ª—ã —É—á–µ–Ω–∏–∫–æ–≤
results_df['–ë–∞–ª–ª—ã'] = results_df[questions].sum(axis=1)
results_df['–ü—Ä–æ—Ü–µ–Ω—Ç'] = (results_df['–ë–∞–ª–ª—ã'] / len(questions) * 100).round(1)

# 2.2. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–¥–∞–Ω–∏—è–º
question_stats = []
for q in questions:
    correct = results_df[q].sum()
    total = len(results_df)
    percent = (correct / total * 100).round(1)

    question_stats.append({
        '–ó–∞–¥–∞–Ω–∏–µ': q,
        '–ü—Ä–∞–≤–∏–ª—å–Ω–æ': correct,
        '–í—Å–µ–≥–æ': total,
        '–ü—Ä–æ—Ü–µ–Ω—Ç': percent
    })

question_stats_df = pd.DataFrame(question_stats)

# –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–∞–Ω–∏—è—Ö
question_stats_df = question_stats_df.merge(test_info, on='–ó–∞–¥–∞–Ω–∏–µ')

# 2.3. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–µ–º–∞–º
topic_stats = question_stats_df.groupby('–¢–µ–º–∞').agg({
    '–ü—Ä–æ—Ü–µ–Ω—Ç': 'mean'
}).round(1).reset_index()
topic_stats.columns = ['–¢–µ–º–∞', '–°—Ä–µ–¥–Ω–∏–π_–ø—Ä–æ—Ü–µ–Ω—Ç']

# 2.4. –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è (–º–µ–Ω–µ–µ 60% –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö)
problem_questions = question_stats_df[question_stats_df['–ü—Ä–æ—Ü–µ–Ω—Ç'] < 60]

# 2.5. –£—á–µ–Ω–∏–∫–∏, –Ω—É–∂–¥–∞—é—â–∏–µ—Å—è –≤ –ø–æ–º–æ—â–∏ (< 50% –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö)
struggling_students = results_df[results_df['–ü—Ä–æ—Ü–µ–Ω—Ç'] < 50][['–£—á–µ–Ω–∏–∫', '–ë–∞–ª–ª—ã', '–ü—Ä–æ—Ü–µ–Ω—Ç']]

# ============================================
# 3. –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø
# ============================================

print("\nüìà –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤...")

# 3.1. –£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å –ø–æ –∑–∞–¥–∞–Ω–∏—è–º
plt.figure(figsize=(12, 6))

# –¶–≤–µ—Ç–∞ –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É
colors = []
for percent in question_stats_df['–ü—Ä–æ—Ü–µ–Ω—Ç']:
    if percent >= 70:
        colors.append('green')
    elif percent >= 50:
        colors.append('orange')
    else:
        colors.append('red')

bars = plt.bar(question_stats_df['–ó–∞–¥–∞–Ω–∏–µ'], question_stats_df['–ü—Ä–æ—Ü–µ–Ω—Ç'], color=colors, alpha=0.7)
plt.axhline(y=60, color='red', linestyle='--', alpha=0.5, label='–ü–æ—Ä–æ–≥ 60%')
plt.xlabel('–ó–∞–¥–∞–Ω–∏—è')
plt.ylabel('–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ (%)')
plt.title('–£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å –ø–æ –∑–∞–¥–∞–Ω–∏—è–º')
plt.xticks(rotation=45)
plt.legend()
plt.grid(axis='y', alpha=0.3)

# –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
for bar in bars:
    height = bar.get_height()
    plt.text(bar.get_x() + bar.get_width() / 2., height + 1,
             f'{height:.0f}%', ha='center', va='bottom', fontsize=9)

plt.tight_layout()
plt.savefig('1_—É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å_–ø–æ_–∑–∞–¥–∞–Ω–∏—è–º.png', dpi=150)
plt.show()

# 3.2. –£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å –ø–æ —Ç–µ–º–∞–º
plt.figure(figsize=(10, 6))
topic_stats = topic_stats.sort_values('–°—Ä–µ–¥–Ω–∏–π_–ø—Ä–æ—Ü–µ–Ω—Ç')

colors_topic = []
for percent in topic_stats['–°—Ä–µ–¥–Ω–∏–π_–ø—Ä–æ—Ü–µ–Ω—Ç']:
    if percent >= 70:
        colors_topic.append('green')
    elif percent >= 50:
        colors_topic.append('orange')
    else:
        colors_topic.append('red')

bars = plt.barh(topic_stats['–¢–µ–º–∞'], topic_stats['–°—Ä–µ–¥–Ω–∏–π_–ø—Ä–æ—Ü–µ–Ω—Ç'],
                color=colors_topic, alpha=0.7)
plt.axvline(x=60, color='red', linestyle='--', alpha=0.5, label='–ü–æ—Ä–æ–≥ 60%')
plt.xlabel('–°—Ä–µ–¥–Ω–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ (%)')
plt.title('–£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å –ø–æ —Ç–µ–º–∞–º')
plt.legend()
plt.grid(axis='x', alpha=0.3)

# –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
for bar in bars:
    width = bar.get_width()
    plt.text(width + 1, bar.get_y() + bar.get_height() / 2,
             f'{width:.0f}%', va='center', fontsize=10)

plt.tight_layout()
plt.savefig('2_—É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å_–ø–æ_—Ç–µ–º–∞–º.png', dpi=150)
plt.show()

# 3.3. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ —É—á–µ–Ω–∏–∫–æ–≤
plt.figure(figsize=(10, 6))
plt.hist(results_df['–ü—Ä–æ—Ü–µ–Ω—Ç'], bins=10, color='skyblue', edgecolor='black', alpha=0.7)
plt.axvline(results_df['–ü—Ä–æ—Ü–µ–Ω—Ç'].mean(), color='red', linestyle='--',
            label=f'–°—Ä–µ–¥–Ω–µ–µ: {results_df["–ü—Ä–æ—Ü–µ–Ω—Ç"].mean():.1f}%')
plt.xlabel('–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤')
plt.ylabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–µ–Ω–∏–∫–æ–≤')
plt.title('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —É—á–µ–Ω–∏–∫–æ–≤')
plt.legend()
plt.grid(axis='y', alpha=0.3)

plt.tight_layout()
plt.savefig('3_—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ_–±–∞–ª–ª–æ–≤.png', dpi=150)
plt.show()

# 3.4. –¢–æ–ø-5 –∏ —Ö—É–¥—à–∏–µ —É—á–µ–Ω–∏–∫–∏
plt.figure(figsize=(12, 6))

# –¢–æ–ø-5
top5 = results_df.nlargest(5, '–ü—Ä–æ—Ü–µ–Ω—Ç')[['–£—á–µ–Ω–∏–∫', '–ü—Ä–æ—Ü–µ–Ω—Ç']]
# –•—É–¥—à–∏–µ 5
bottom5 = results_df.nsmallest(5, '–ü—Ä–æ—Ü–µ–Ω—Ç')[['–£—á–µ–Ω–∏–∫', '–ü—Ä–æ—Ü–µ–Ω—Ç']]

plt.subplot(1, 2, 1)
bars1 = plt.barh(range(len(top5)), top5['–ü—Ä–æ—Ü–µ–Ω—Ç'].values, color='green', alpha=0.7)
plt.yticks(range(len(top5)), top5['–£—á–µ–Ω–∏–∫'].values)
plt.xlabel('–ü—Ä–æ—Ü–µ–Ω—Ç')
plt.title('–¢–æ–ø-5 –ª—É—á—à–∏—Ö —É—á–µ–Ω–∏–∫–æ–≤')
plt.xlim(0, 110)
plt.gca().invert_yaxis()
for i, v in enumerate(top5['–ü—Ä–æ—Ü–µ–Ω—Ç'].values):
    plt.text(v + 1, i, f'{v:.1f}%', va='center')

plt.subplot(1, 2, 2)
bars2 = plt.barh(range(len(bottom5)), bottom5['–ü—Ä–æ—Ü–µ–Ω—Ç'].values, color='red', alpha=0.7)
plt.yticks(range(len(bottom5)), bottom5['–£—á–µ–Ω–∏–∫'].values)
plt.xlabel('–ü—Ä–æ—Ü–µ–Ω—Ç')
plt.title('–•—É–¥—à–∏–µ 5 —É—á–µ–Ω–∏–∫–æ–≤')
plt.xlim(0, 110)
plt.gca().invert_yaxis()
for i, v in enumerate(bottom5['–ü—Ä–æ—Ü–µ–Ω—Ç'].values):
    plt.text(v + 1, i, f'{v:.1f}%', va='center')

plt.tight_layout()
plt.savefig('4_—Ç–æ–ø_–∏_—Ö—É–¥—à–∏–µ.png', dpi=150)
plt.show()

# ============================================
# 4. –°–û–•–†–ê–ù–ï–ù–ò–ï –í EXCEL
# ============================================

print("\nüíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Excel...")

with pd.ExcelWriter('test_results_analysis.xlsx') as writer:
    # –õ–∏—Å—Ç 1: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É—á–µ–Ω–∏–∫–æ–≤
    results_sorted = results_df.sort_values('–ü—Ä–æ—Ü–µ–Ω—Ç', ascending=False)
    results_sorted.to_excel(writer, sheet_name='–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É—á–µ–Ω–∏–∫–æ–≤', index=False)

    # –õ–∏—Å—Ç 2: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–¥–∞–Ω–∏—è–º
    question_stats_sorted = question_stats_df.sort_values('–ü—Ä–æ—Ü–µ–Ω—Ç')
    question_stats_sorted.to_excel(writer, sheet_name='–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–¥–∞–Ω–∏—è–º', index=False)

    # –õ–∏—Å—Ç 3: –£—á–µ–Ω–∏–∫–∏, –Ω—É–∂–¥–∞—é—â–∏–µ—Å—è –≤ –ø–æ–º–æ—â–∏
    if len(struggling_students) > 0:
        struggling_students.to_excel(writer, sheet_name='–¢—Ä–µ–±—É—é—Ç –ø–æ–º–æ—â–∏', index=False)

    # –õ–∏—Å—Ç 4: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–µ–º–∞–º
    topic_stats.to_excel(writer, sheet_name='–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–µ–º–∞–º', index=False)

print("‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ test_results_analysis.xlsx")

# ============================================
# 5. –°–û–ó–î–ê–ù–ò–ï –¢–ï–ö–°–¢–û–í–û–ì–û –û–¢–ß–ï–¢–ê
# ============================================

print("\nüìù –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞...")

report_filename = 'test_report.txt'

with open(report_filename, 'w', encoding='utf-8') as f:
    f.write("=" * 70 + "\n")
    f.write("–û–¢–ß–ï–¢ –ü–û –†–ï–ó–£–õ–¨–¢–ê–¢–ê–ú –ö–û–ù–¢–†–û–õ–¨–ù–û–ô –†–ê–ë–û–¢–´\n")
    f.write(f"–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞: {datetime.now().strftime('%d.%m.%Y %H:%M')}\n")
    f.write("=" * 70 + "\n\n")

    # 1. –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    f.write("1. –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê\n")
    f.write("-" * 70 + "\n")
    f.write(f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–µ–Ω–∏–∫–æ–≤: {len(results_df)}\n")
    f.write(f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞–Ω–∏–π: {len(questions)}\n")
    f.write(f"–°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–ª–∞—Å—Å–∞: {results_df['–ü—Ä–æ—Ü–µ–Ω—Ç'].mean():.1f}%\n")
    f.write(f"–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {results_df['–ü—Ä–æ—Ü–µ–Ω—Ç'].max():.1f}%\n")
    f.write(f"–•—É–¥—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {results_df['–ü—Ä–æ—Ü–µ–Ω—Ç'].min():.1f}%\n\n")

    # 2. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –æ—Ü–µ–Ω–∫–∞–º
    f.write("2. –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –£–ß–ï–ù–ò–ö–û–í\n")
    f.write("-" * 70 + "\n")

    excellent = len(results_df[results_df['–ü—Ä–æ—Ü–µ–Ω—Ç'] >= 85])
    good = len(results_df[(results_df['–ü—Ä–æ—Ü–µ–Ω—Ç'] >= 70) & (results_df['–ü—Ä–æ—Ü–µ–Ω—Ç'] < 85)])
    satisfactory = len(results_df[(results_df['–ü—Ä–æ—Ü–µ–Ω—Ç'] >= 50) & (results_df['–ü—Ä–æ—Ü–µ–Ω—Ç'] < 70)])
    fail = len(results_df[results_df['–ü—Ä–æ—Ü–µ–Ω—Ç'] < 50])

    f.write(f"–û—Ç–ª–∏—á–Ω–æ (‚â•85%): {excellent} —á–µ–ª.\n")
    f.write(f"–•–æ—Ä–æ—à–æ (70-84%): {good} —á–µ–ª.\n")
    f.write(f"–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ (50-69%): {satisfactory} —á–µ–ª.\n")
    f.write(f"–ù–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ (<50%): {fail} —á–µ–ª.\n\n")

    # 3. –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è
    f.write("3. –ü–†–û–ë–õ–ï–ú–ù–´–ï –ó–ê–î–ê–ù–ò–Ø (<60% –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö)\n")
    f.write("-" * 70 + "\n")

    if len(problem_questions) > 0:
        for _, row in problem_questions.iterrows():
            f.write(f"\n{row['–ó–∞–¥–∞–Ω–∏–µ']}:\n")
            f.write(f"  –¢–µ–º–∞: {row['–¢–µ–º–∞']}\n")
            f.write(f"  –ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: {row['–ü—Ä–∞–≤–∏–ª—å–Ω–æ']}/{row['–í—Å–µ–≥–æ']} ({row['–ü—Ä–æ—Ü–µ–Ω—Ç']:.0f}%)\n")
            f.write(f"  –°–ª–æ–∂–Ω–æ—Å—Ç—å: {row['–°–ª–æ–∂–Ω–æ—Å—Ç—å']}\n")
    else:
        f.write("–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π —Å —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å—é –Ω–∏–∂–µ 60%\n")

    # 4. –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ç–µ–º—ã
    f.write("\n4. –ê–ù–ê–õ–ò–ó –¢–ï–ú\n")
    f.write("-" * 70 + "\n")

    for _, row in topic_stats.iterrows():
        status = "‚úÖ –•–û–†–û–®–û" if row['–°—Ä–µ–¥–Ω–∏–π_–ø—Ä–æ—Ü–µ–Ω—Ç'] >= 70 else \
            "‚ö†Ô∏è  –ù–£–ñ–ù–û –£–õ–£–ß–®–ò–¢–¨" if row['–°—Ä–µ–¥–Ω–∏–π_–ø—Ä–æ—Ü–µ–Ω—Ç'] >= 50 else \
                "‚ùå –ü–†–û–ë–õ–ï–ú–ê"
        f.write(f"{row['–¢–µ–º–∞']}: {row['–°—Ä–µ–¥–Ω–∏–π_–ø—Ä–æ—Ü–µ–Ω—Ç']:.0f}% - {status}\n")

    # 5. –£—á–µ–Ω–∏–∫–∏, –Ω—É–∂–¥–∞—é—â–∏–µ—Å—è –≤ –ø–æ–º–æ—â–∏
    f.write("\n5. –£–ß–ï–ù–ò–ö–ò, –ù–£–ñ–î–ê–Æ–©–ò–ï–°–Ø –í –ü–û–ú–û–©–ò (<50%)\n")
    f.write("-" * 70 + "\n")

    if len(struggling_students) > 0:
        for _, row in struggling_students.iterrows():
            f.write(f"  {row['–£—á–µ–Ω–∏–∫']}: {row['–ë–∞–ª–ª—ã']} –±–∞–ª–ª–æ–≤ ({row['–ü—Ä–æ—Ü–µ–Ω—Ç']:.1f}%)\n")
    else:
        f.write("–í—Å–µ —É—á–µ–Ω–∏–∫–∏ —Å–ø—Ä–∞–≤–∏–ª–∏—Å—å —Å —Ä–∞–±–æ—Ç–æ–π\n")

    # 6. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    f.write("\n6. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò\n")
    f.write("-" * 70 + "\n")

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ç–µ–º—ã
    problem_topics = topic_stats[topic_stats['–°—Ä–µ–¥–Ω–∏–π_–ø—Ä–æ—Ü–µ–Ω—Ç'] < 60]

    if len(problem_topics) > 0:
        f.write("–¢–µ–º—ã –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è:\n")
        for _, row in problem_topics.iterrows():
            f.write(f"  ‚Ä¢ {row['–¢–µ–º–∞']} (—É—Å–≤–æ–µ–Ω–æ –Ω–∞ {row['–°—Ä–µ–¥–Ω–∏–π_–ø—Ä–æ—Ü–µ–Ω—Ç']:.0f}%)\n")
        f.write("\n")

    if len(struggling_students) > 0:
        f.write(f"–û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –¥–ª—è {len(struggling_students)} —É—á–µ–Ω–∏–∫–æ–≤\n")

    # –û–±—â–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
    if results_df['–ü—Ä–æ—Ü–µ–Ω—Ç'].mean() < 60:
        f.write("\n‚ö†Ô∏è  –°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–ª–∞—Å—Å–∞ –Ω–∏–∑–∫–∏–π. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:\n")
        f.write("   ‚Ä¢ –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–∞–±–æ—Ç—É –Ω–∞–¥ –æ—à–∏–±–∫–∞–º–∏\n")
        f.write("   ‚Ä¢ –£–¥–µ–ª–∏—Ç—å –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –∑–∞–¥–∞–Ω–∏—è–º\n")
    else:
        f.write("\n‚úÖ –°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–ª–∞—Å—Å–∞ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–π\n")

    f.write("\n" + "=" * 70 + "\n")
    f.write("–ö–æ–Ω–µ—Ü –æ—Ç—á–µ—Ç–∞\n")
    f.write("=" * 70 + "\n")

print(f"‚úÖ –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ {report_filename}")

# ============================================
# 6. –í–´–í–û–î –ò–¢–û–ì–û–í –í –ö–û–ù–°–û–õ–¨
# ============================================

print("\n" + "=" * 70)
print("–ò–¢–û–ì–ò –ê–ù–ê–õ–ò–ó–ê:")
print("=" * 70)

print(f"\nüìä –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:")
print(f"   ‚Ä¢ –°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {results_df['–ü—Ä–æ—Ü–µ–Ω—Ç'].mean():.1f}%")
print(
    f"   ‚Ä¢ –õ—É—á—à–∏–π —É—á–µ–Ω–∏–∫: {results_df.loc[results_df['–ü—Ä–æ—Ü–µ–Ω—Ç'].idxmax(), '–£—á–µ–Ω–∏–∫']} ({results_df['–ü—Ä–æ—Ü–µ–Ω—Ç'].max():.1f}%)")
print(
    f"   ‚Ä¢ –•—É–¥—à–∏–π —É—á–µ–Ω–∏–∫: {results_df.loc[results_df['–ü—Ä–æ—Ü–µ–Ω—Ç'].idxmin(), '–£—á–µ–Ω–∏–∫']} ({results_df['–ü—Ä–æ—Ü–µ–Ω—Ç'].min():.1f}%)")

print(f"\nüìö –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –¢–ï–ú–ê–ú:")
for _, row in topic_stats.iterrows():
    print(f"   ‚Ä¢ {row['–¢–µ–º–∞']}: {row['–°—Ä–µ–¥–Ω–∏–π_–ø—Ä–æ—Ü–µ–Ω—Ç']:.0f}%")

print(f"\n‚ö†Ô∏è  –ü–†–û–ë–õ–ï–ú–ù–´–ï –ó–ê–î–ê–ù–ò–Ø (<60%):")
if len(problem_questions) > 0:
    for _, row in problem_questions.iterrows():
        print(f"   ‚Ä¢ {row['–ó–∞–¥–∞–Ω–∏–µ']} ({row['–¢–µ–º–∞']}): {row['–ü—Ä–æ—Ü–µ–Ω—Ç']:.0f}%")
else:
    print("   –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π")

print(f"\nüë• –£–ß–ï–ù–ò–ö–ò, –ù–£–ñ–î–ê–Æ–©–ò–ï–°–Ø –í –ü–û–ú–û–©–ò (<50%): {len(struggling_students)} —á–µ–ª.")

print(f"\nüíæ –°–û–ó–î–ê–ù–ù–´–ï –§–ê–ô–õ–´:")
print("   1. test_results_analysis.xlsx - –ø–æ–ª–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã")
print("   2. test_report.txt - —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç")
print("   3. 1_—É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å_–ø–æ_–∑–∞–¥–∞–Ω–∏—è–º.png")
print("   4. 2_—É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å_–ø–æ_—Ç–µ–º–∞–º.png")
print("   5. 3_—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ_–±–∞–ª–ª–æ–≤.png")
print("   6. 4_—Ç–æ–ø_–∏_—Ö—É–¥—à–∏–µ.png")

print("\n" + "=" * 70)
print("‚úÖ –ê–ù–ê–õ–ò–ó –ó–ê–í–ï–†–®–ï–ù!")
print("=" * 70)